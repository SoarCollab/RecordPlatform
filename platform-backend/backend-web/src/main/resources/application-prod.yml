server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: /record-platform
  # HTTPS/SSL Configuration (disabled by default, use reverse proxy for HTTPS)
  ssl:
    enabled: ${SSL_ENABLED:false}
    key-store: ${SSL_KEY_STORE:classpath:keystore.p12}
    key-store-password: ${SSL_KEY_STORE_PASSWORD}
    key-store-type: ${SSL_KEY_STORE_TYPE:PKCS12}
    key-alias: ${SSL_KEY_ALIAS:server}

# Security settings
security:
  require-ssl: ${REQUIRE_SSL:false}
  # HTTP to HTTPS redirect port (when using embedded Tomcat)
  http-redirect-port: ${HTTP_REDIRECT_PORT:8080}
spring:
  # Flyway 生产环境配置
  flyway:
    enabled: true
    baseline-on-migrate: true
    clean-disabled: true

  # datasource 核心配置 (url/username/password/druid凭证) 从 Nacos 加载 (backend-web.yaml)
  datasource:
    druid:
      type: com.alibaba.druid.pool.DruidDataSource
      driver-class-name: com.mysql.cj.jdbc.Driver
      initialSize: 5
      minIdle: 5
      maxActive: 40
      web-stat-filter:
        enabled: true
        url-pattern: /*
        exclusions: /druid/*,*.js,*.css,*.gif,*.jpg,*.bmp,*.png,*.ico
      stat-view-servlet:
        enabled: false # 生产环境禁用 Druid 监控页面
        url-pattern: /druid/*
        allow:
        deny:
        reset-enable: false

  # mail 配置从 Nacos 加载 (backend-web.yaml)

  # rabbitmq 配置从 Nacos 加载 (backend-web.yaml)

  # redis 配置 (username/password 从 Nacos 加载)
  data:
    redis:
      database: 0
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: 5000
s3:
  endpoint: ${S3_ENDPOINT:http://localhost:9000}
  access-key: ${S3_ACCESS_KEY}
  secret-key: ${S3_SECRET_KEY}
  bucket-name: ${S3_BUCKET_NAME:forum}

# dubbo配置
dubbo:
  application:
    name: RecordPlatform_Main
    logger: slf4j
    qos-port: ${QOS_BACKEND_PORT:22330}
    check-serializable: false
    protocol: tri
  protocol: # Dubbo 协议配置
    name: tri # 使用 Triple 协议
    payload: 104857600 # 将最大载荷大小设置为 100MB (100 * 1024 * 1024 bytes)
  registry:
    register-mode: instance
    address: nacos://${NACOS_HOST:localhost}:${NACOS_PORT:8848}?username=${NACOS_USERNAME}&password=${NACOS_PASSWORD}
    enable-empty-protection: true  # 空保护：收到空列表时保留旧地址，防止服务闪断
  consumer:
    timeout: 30000 # 全局消费者超时设置为30秒
    references:
      cn.flying.platformapi.external.DistributedStorageService: # 这是interface的简单名称，或者全限定名
        methods:
          - name: storeFile
            timeout: 60000 # 将 storeFile 方法的超时时间设置为 60000ms (60秒)
            retries: 0 # 文件存储操作通常不建议重试，除非有幂等性保证且业务允许

# 日志配置
logging:
  level:
    root: WARN # 全局日志级别保持为WARN

# 生产环境禁用 API 文档
knife4j:
  production: true # 生产环境屏蔽所有 Swagger 相关资源

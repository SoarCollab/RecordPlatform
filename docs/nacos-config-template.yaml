# ==============================================================================
# RecordPlatform Backend-Web Nacos 配置模板
#
# 使用方法：
# 1. 登录 Nacos 控制台 (http://localhost:8848/nacos)
# 2. 进入「配置管理」->「配置列表」
# 3. 点击「+」新建配置
# 4. Data ID: backend-web.yaml
# 5. Group: DEFAULT_GROUP
# 6. 配置格式: YAML
# 7. 复制以下内容并填入实际值
# ==============================================================================

# ==============================================================================
# 数据库配置 (MySQL)
# ==============================================================================
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/RecordPlatform?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&useSSL=false
    username: USER_NAME
    password: YOUR_PASSWORD
    druid:
      login-username: USER_NAME
      login-password: YOUR_PASSWORD

  # ==============================================================================
  # Redis 配置
  # ==============================================================================
  data:
    redis:
      username: default
      password: YOUR_PASSWORD

  # ==============================================================================
  # 邮件服务配置 (SMTP)
  # ==============================================================================
  mail:
    host: smtp.example.com
    username: YOURNAME@example.com
    password: YOUR_PASSWORD

  # ==============================================================================
  # RabbitMQ 配置
  # ==============================================================================
  rabbitmq:
    addresses: localhost:5672
    username: rabbitmq
    password: rabbitmq


# ==============================================================================
# RecordPlatform Storage Service Nacos 配置模板
#
# 使用方法：
# 1. 在 Nacos 控制台新建配置
# 2. Data ID: platform-storage.yaml
# 3. Group: DEFAULT_GROUP
# 4. 配置格式: YAML
# ==============================================================================

# ==============================================================================
# 分布式存储配置
# ==============================================================================
storage:
  # --------------------------------------------------------------------------
  # 必须配置：活跃域列表（按优先级排序）
  # 单域模式（开发）：只配置一个域
  # 多域模式（生产）：配置多个域实现跨域容错
  # --------------------------------------------------------------------------
  active-domains:
    - domain-a
    - domain-b

  # --------------------------------------------------------------------------
  # 可选：外部访问端点（v3.2.0 新增）
  # 用于生成预签名 URL 时替换内部端点地址，解决跨网段（如 VPN）访问问题
  # 格式：http://host:port（不带尾部斜杠）
  # 如果未配置，则使用各节点的 endpoint 配置
  # --------------------------------------------------------------------------
  # external-endpoint: http://10.1.0.2:9000

  # --------------------------------------------------------------------------
  # 可选：备用域（用于故障转移）
  # 开发环境可不配置
  # --------------------------------------------------------------------------
  standby-domain: standby

  # --------------------------------------------------------------------------
  # 副本策略配置（v3.1.0 新增）
  # --------------------------------------------------------------------------
  replication:
    factor: 2                     # 副本数量，默认=活跃域数量
    quorum: auto                  # 仲裁策略: auto|majority|all|具体数字
                                  # auto: 2副本=全部成功, 3+副本=多数派(N/2+1)
                                  # majority: 始终使用多数派
                                  # all: 全部成功
                                  # 数字: 手动指定仲裁数

  # --------------------------------------------------------------------------
  # 降级写入配置（v3.1.0 新增）
  # --------------------------------------------------------------------------
  degraded-write:
    enabled: true                 # 是否允许降级写入（当某个故障域完全不可用时）
    min-replicas: 1               # 降级模式下的最小副本数（低于此值拒绝写入）
    track-for-sync: true          # 是否记录降级写入以便后续同步

  # --------------------------------------------------------------------------
  # 一致性哈希配置
  # --------------------------------------------------------------------------
  virtualNodesPerNode: 150

  # --------------------------------------------------------------------------
  # 域详细配置（可选）
  # --------------------------------------------------------------------------
  domains:
    - name: domain-a
      minNodes: 1           # 触发备用节点提升的最少健康节点数
      replicaCount: 1       # 该域中每个分片的副本数
      acceptsWrites: true
    - name: domain-b
      minNodes: 1
      replicaCount: 1
      acceptsWrites: true
    - name: standby
      minNodes: 0
      replicaCount: 0
      acceptsWrites: false

  # --------------------------------------------------------------------------
  # 存储节点配置
  # --------------------------------------------------------------------------
  nodes:
    # 域 A 节点
    - name: node-a1
      endpoint: http://s3-a1:9000
      accessKey: YOUR_ACCESS_KEY
      secretKey: YOUR_SECRET_KEY
      faultDomain: domain-a
      weight: 100
      enabled: true
      metricsPath: /minio/v2/metrics/node

    # 域 B 节点
    - name: node-b1
      endpoint: http://s3-b1:9000
      accessKey: YOUR_ACCESS_KEY
      secretKey: YOUR_SECRET_KEY
      faultDomain: domain-b
      weight: 100
      enabled: true
      metricsPath: /minio/v2/metrics/node

    # 备用节点（可选）
    - name: standby-node1
      endpoint: http://s3-standby:9000
      accessKey: YOUR_ACCESS_KEY
      secretKey: YOUR_SECRET_KEY
      faultDomain: standby
      weight: 100
      enabled: true
      metricsPath: /minio/v2/metrics/node

  # --------------------------------------------------------------------------
  # 副本一致性修复配置
  # --------------------------------------------------------------------------
  consistency:
    repair:
      enabled: true               # 是否启用定时一致性修复
      cron: "0 */15 * * * ?"      # Cron 表达式（默认每 15 分钟）
      batch-size: 100             # 每批处理对象数
      lock-timeout-seconds: 600   # 分布式锁超时时间（秒）

  # --------------------------------------------------------------------------
  # 数据再平衡配置
  # --------------------------------------------------------------------------
  rebalance:
    enabled: true                 # 是否启用自动再平衡（节点故障/提升时触发）
    rate-limit-per-second: 10     # 每秒最大复制对象数（限流防止 I/O 饱和）
    cleanup-source: false         # 再平衡后是否删除源数据（默认 false，确保数据安全）


# ==============================================================================
# 开发环境单域模式示例 (platform-storage-local.yaml)
# ==============================================================================
# storage:
#   active-domains:
#     - local
#   nodes:
#     - name: local-minio
#       endpoint: http://localhost:9000
#       accessKey: minioadmin
#       secretKey: minioadmin
#       faultDomain: local
#       weight: 100
#       enabled: true
